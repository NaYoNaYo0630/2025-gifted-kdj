import uuid
import streamlit as st
import ollama
from utils import check_ollama
import re

def clean_surrogates(text):
    # ìœ ë‹ˆì½”ë“œ surrogate ë²”ìœ„ ì œê±°
    return re.sub(r'[\ud800-\udfff]', '', text)

st.set_page_config(page_title="AI Debate Room")
st.sidebar.title("Settings")

# í•œì–´/ì˜ì–´ ì„¤ì •
if "languages" not in st.session_state:
    st.session_state.languages = ""
languages = ['Korean', 'English']
st.session_state.languages = st.sidebar.selectbox("Choose languages", languages)

# AI ê°œìˆ˜ ì„ íƒ & ì„¤ì • ì…ë ¥
NumberOfAi = [2, 3, 4, 5]
if "NumberOfAi" not in st.session_state:
    st.session_state.NumberOfAi = 2

selected_num = st.sidebar.selectbox(
    "Choose the number of AI",
    NumberOfAi,
    index=NumberOfAi.index(st.session_state["NumberOfAi"])
)
if selected_num != st.session_state["NumberOfAi"]:
    st.session_state["NumberOfAi"] = selected_num

for i in range(max(NumberOfAi)):
    key = f"AI{i+1}_setting"
    if i < st.session_state["NumberOfAi"]:
        st.session_state[key] = st.sidebar.text_area(
            f"AI{i+1} ì£¼ì¥ ê²½í–¥ì„± ì„¤ì •",
            value=st.session_state.get(key, ""),
            help=f"AI{i+1}ì˜ ì£¼ì¥ ê°€ëŠ¥ì„± ë©”ì‹œì§€ ì„¤ì •"
        )

if "model" not in st.session_state:
    check_ollama()
    model_list = [m["model"] for m in ollama.list()["models"]]
    st.session_state.model = model_list[0] if model_list else ""

models = [m["model"] for m in ollama.list()["models"]]

# AI ê°œë³„ ëª¨ë¸ ì„¤ì •
for i in range(st.session_state["NumberOfAi"]):
    key = f"AI{i+1}_model"
    default_index = 0
    if key in st.session_state and st.session_state[key] in models:
        default_index = models.index(st.session_state[key])

    st.sidebar.selectbox(
        f"AI{i+1} ëª¨ë¸ ì„¤ì •",
        models,
        index=default_index,
        key=key  # âœ… í‚¤ë§Œ ì£¼ê³  ê°’ í• ë‹¹ì€ í•˜ì§€ ì•ŠìŒ
    )
system_prompt = st.sidebar.text_area("System Prompt")

# ì±„íŒ… ì´ˆê¸°í™”
if "chats" not in st.session_state:
    st.session_state.chats = {}
if "current_chat_id" not in st.session_state:
    st.session_state.current_chat_id = None

# ìƒˆ ì±„íŒ… ìƒì„±
if st.sidebar.button("\u2795 New Chat"):
    chat_id = str(uuid.uuid4())
    st.session_state.current_chat_id = chat_id
    st.session_state.chats[chat_id] = {
        "name": "ìƒˆë¡œìš´ ì±„íŒ…",
        "messages": [{"role": "system", "content": system_prompt}]
    }

for cid, chat_info in st.session_state.chats.items():
    if st.sidebar.button(chat_info["name"], key=cid):
        st.session_state.current_chat_id = cid

# ì•„ì´ì½˜ ë°°ì • (í•˜ë‚˜ë§Œ)
if "avatar_map" not in st.session_state:
    emoji_numbers = ["1ï¸âƒ£", "2ï¸âƒ£", "3ï¸âƒ£", "4ï¸âƒ£", "5ï¸âƒ£"]
    st.session_state.avatar_map = {"user": "ğŸ‘¤"}
    for i in range(st.session_state.NumberOfAi):
        st.session_state.avatar_map[f"AI{i+1}"] = emoji_numbers[i]

avatar_map = st.session_state.avatar_map
num_ai = st.session_state.NumberOfAi

# ë²„íŠ¼ ìƒíƒœ ê´€ë¦¬
st.session_state.setdefault("show_user_judge", False)
st.session_state.setdefault("show_model_judge", False)

# ì±„íŒ… ì‹œì‘
chat_id = st.session_state.current_chat_id
if chat_id:
    chat = st.session_state.chats[chat_id]
    st.title(chat["name"])

    for msg in chat["messages"]:
        if msg["role"] != "system":
            avatar = avatar_map.get(msg["role"], "ğŸ’¬")
            with st.chat_message(msg["role"], avatar=avatar):
                st.markdown(msg["content"])

    user_input = st.chat_input("Enter debate topic or reply")

    if user_input:
        display_input = user_input

        # âœ… ìˆ˜ì • 1: ë‚´ë¶€ ëª…ë ¹ í¬í•¨ system_inputì€ AIìš© system promptì—ì„œë§Œ ì‚¬ìš©
        chat["messages"].append({"role": "user", "content": user_input})

        with st.chat_message("user", avatar=avatar_map["user"]):
            st.markdown(display_input)

        if len(chat["messages"]) == 3 and chat["name"] == "ìƒˆë¡œìš´ ì±„íŒ…":
            summary_prompt = [
                {"role": "system", "content": "You are a helpful assistant that creates concise chat titles."},
                {"role": "user", "content": f"Generate a short (max 5 words) title summarizing the conversation:\nUser: {chat['messages'][1]['content']}"}
            ]
            try:
                new_title = ""
                stream = ollama.chat(model=st.session_state.model, messages=summary_prompt, stream=True)
                for chunk in stream:
                    new_title += chunk.message.content
                chat["name"] = new_title.strip()
                st.rerun()
            except:
                pass

        max_turns = 3
        for turn in range(max_turns):
            print(chat["messages"])
            st.divider()
            if "show_user_judge" not in st.session_state:
                st.session_state.show_user_judge = False

            if st.button("ğŸ‘¤ ì‚¬ìš©ì ìŠ¹ì ì„ íƒ", key="user_judge_btn"):
                st.session_state.show_user_judge = True

            if st.session_state.show_user_judge:
                choice = st.selectbox(
                    "ìŠ¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”",
                    [f"AI{i+1}" for i in range(num_ai)],
                    key="user_choice_select"
                )
                st.success(f"ğŸ‘¤ ì‚¬ìš©ì íŒë‹¨: {choice} ìŠ¹ë¦¬!")

            if st.button("ğŸ§ JudgeModel ì¡°ì–¸", key=f"model_judge_button_{turn}"):
                st.session_state.show_model_judge = True
            if st.session_state.show_model_judge:
                judge_instruction = {
                    "Korean": "ë‹¹ì‹ ì€ í† ë¡  ê°ì‹œìì…ë‹ˆë‹¤. ì´ í† ë¡ ì˜ ìŠ¹ìì™€ ì´ìœ ë¥¼ ì œì‹œí•´ ì£¼ì‹­ì‹œì˜¤.",
                    "English": "You are a debate observer. Please indicate the winner of this debate and the reasons why."
                }
                judge_prompt = [
                    {"role": "system", "content": judge_instruction[st.session_state.languages]},
                    *chat["messages"]
                ]
                judge_model = "mistral"
                judge_result = ollama.chat(model=judge_model, messages=judge_prompt, stream=False)["message"]["content"]
                st.markdown(judge_result)

            for i in range(num_ai):
                ai_role = f"AI{i+1}"
                setting_key = f"AI{i+1}_setting"
                setting = st.session_state.get(setting_key, "")
                opponents = [f"AI{j+1}" for j in range(num_ai) if j != i]
                opponent_str = ", ".join(opponents)

                # âœ… ìˆ˜ì • 2: system_introëŠ” ì´ ì‹œì ì— ìƒì„±ë˜ì–´ì•¼ í•¨
                system_intro = (
                    f"You are {ai_role}. You are debating against {opponent_str}. " +
                    setting + " " +
                    ("Do not mention the prompt. Choose one clear stance and debate logically." if st.session_state.languages == "English"
                     else "í”„ë¡¬í”„íŠ¸ì— ëŒ€í•´ ë§í•˜ì§€ ë§ê³  í•œ ê°€ì§€ ì…ì¥ì„ ë¶„ëª…íˆ ì •í•´ ë…¼ë¦¬ì ìœ¼ë¡œ ì£¼ì¥í•˜ì„¸ìš”.")
                )

                messages = [{"role": "system", "content": system_intro}] + chat["messages"]

                response = ollama.chat(model=st.session_state.model, messages=messages, stream=False)["message"]["content"]

                with st.chat_message(ai_role, avatar=avatar_map[ai_role]):
                    st.markdown(response)

                chat["messages"].append({"role": f"assistant{i+1}", "content": response})
                chat["messages"].append({
                    "role": "user",
                    "content": f"{opponent_str} just said: {response}\nPlease rebut and make your own argument. No more than 3 sentences."
                })

else:
    st.info("ì˜¤ëŠ˜ì˜ í† ë¡  ì£¼ì œëŠ” ë¬´ì—‡ì¸ê°€ìš”?\nì™¼ìª½ì—ì„œ ì±„íŒ…ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆ ì±„íŒ…ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.")
